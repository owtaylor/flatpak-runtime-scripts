flatpak:
    id: @ID_PREFIX@.Sdk
    build-runtime: true
    name: @RELEASE@/flatpak-sdk
    component: flatpak-sdk
    branch: @RELEASE@
    runtime: @ID_PREFIX@.Platform
    finish-args: >
        --env=ALSA_CONFIG_DIR=/usr/share/alsa
        --env=ALSA_CONFIG_PATH=/usr/share/alsa/alsa.conf
        --env=GI_TYPELIB_PATH=/app/lib64/girepository-1.0
        --env=GST_PLUGIN_SYSTEM_PATH=/app/lib64/gstreamer-1.0:/usr/lib64/gstreamer-1.0
        --env=LUA_PATH="/app/share/lua/5.4/?.lua;/app/share/lua/5.4/?/init.lua;/app/lib64/lua/5.4/?.lua;/app/lib64/lua/5.4/?/init.lua;;"
        --env=LUA_CPATH="/app/lib64/lua/5.4/?.so;;"
        --env=PATH=/app/sbin:/app/bin:/usr/sbin:/usr/bin
        --env=PINENTRY_BINARY=/usr/bin/pinentry-gnome3
        --env=PYTHONUSERBASE=/var/data/python
        --env=TCLLIBPATH=/app/lib64/tcl8.6
        --env=XDG_DATA_DIRS=/app/share:/usr/share:/usr/share/runtime/share:/run/host/user-share:/run/host/share
        --env=GPROFNG_SYSCONFDIR=/etc
        --extension=org.freedesktop.Platform.GL=version=1.4
        --extension=org.freedesktop.Platform.GL=directory=lib64/GL
        --extension=org.freedesktop.Platform.GL=subdirectories=true
        --extension=org.freedesktop.Platform.GL=no-autodownload=true
        --extension=org.freedesktop.Platform.GL=autodelete=false
        --extension=org.freedesktop.Platform.GL=add-ld-path=lib
        --extension=org.freedesktop.Platform.GL=merge-dirs=vulkan/icd.d;glvnd/egl_vendor.d;OpenCL/vendors;lib/dri;lib/d3d;vulkan/explicit_layer.d;vulkan/implicit_layer.d
        --extension=org.freedesktop.Platform.GL=download-if=active-gl-driver
        --extension=org.freedesktop.Platform.GL=enable-if=active-gl-driver
        --extension=org.freedesktop.Platform.GL=autoprune-unless=active-gl-driver
        --extension=org.freedesktop.Platform.openh264=version=2.4.1
        --extension=org.freedesktop.Platform.openh264=directory=lib64/openh264
        --extension=org.freedesktop.Platform.openh264=add-ld-path=extra
        --extension=org.freedesktop.Platform.openh264=no-autodownload=true

    # For applications, appstream-compose is run automatically along with other processing
    # of the tree. For runtimes, we have to run it manually. flatpak-container-tools local
    # builds have issues if the cleanup script outputs to stdout, hence the 1>&2
    # redirection.
    cleanup-commands: |
        appstream-compose --verbose   \
            --prefix=/usr             \
            --basename=@ID_PREFIX@.Sdk \
            --origin=flatpak          \
            @ID_PREFIX@.Sdk 1>&2

        mv -f /usr/bin/flatpak-xdg-email /usr/bin/xdg-email
        mv -f /usr/bin/flatpak-xdg-open /usr/bin/xdg-open

        # enable dynamic ld.so.cache generation
        [ -e /usr/bin/ldconfig ] || ln -s ../sbin/ldconfig /usr/bin/ldconfig
        cat /etc/ld.so.conf.d/*.conf > /etc/ld.so.conf
        rm -f /etc/ld.so.conf.d/*.conf

        # User ALSA configuration can conflict with flatpak setup
        # https://gitlab.com/freedesktop-sdk/freedesktop-sdk/-/issues/857
        sed -e '/~\/\.asoundrc/d' -e 's|/alsa/asoundrc|/asound.conf|' /usr/share/alsa/alsa.conf

        # Create a directory for mounting extension points
        mkdir -p /usr/lib64/GL
        mkdir -p /usr/lib64/openh264

        rm -r /etc/glvnd
        ln -s ../lib64/GL/glvnd /etc/glvnd

        rm -r /etc/vulkan
        ln -s ../lib64/GL/vulkan /etc/vulkan

        touch -d @0 /usr/share/fonts /usr/share/fonts/*
        fc-cache -rs

    packages: []
